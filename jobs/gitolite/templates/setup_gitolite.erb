#!/usr/bin/env bash

# Create git user, if not already created
#
# Tutorials being followed:
# * http://www.bigfastblog.com/gitolite-installation-step-by-step

set -u # report the usage of uninitialized variables
set +x

export GIT_USER='<%= (properties.git && properties.git.login) || 'git' %>'
export GIT_USER_GRP=${GIT_USER}:${GIT_USER}
export GIT_PASSWORD="<%= (properties.git && properties.git.password) || '${GIT_USER}' %>"
export GIT_HOME="/home/${GIT_USER}"
export GIT_INITIAL_KEY='<%= properties.git.initial_admin_key %>'

export HOME=${GIT_HOME}
packages=/var/vcap/packages

if [[ ! -d ${GIT_HOME} ]]
then
  /usr/sbin/adduser \
      --system \
      --shell /bin/bash \
      --gecos 'git version control' \
      --group \
      --disabled-password \
      --home ${GIT_HOME} ${GIT_USER}

  touch ${GIT_HOME}/.bashrc
  echo 'export PATH=${packages}/perl/bin:$PATH' >> ${GIT_HOME}/.bashrc
  echo 'export PATH=${packages}/git/bin:$PATH' >> ${GIT_HOME}/.bashrc
  echo 'export PATH=${packages}/gitolite/src:$PATH' >> ${GIT_HOME}/.bashrc
  chpst -u ${GIT_USER_GRP} mkdir -p ${GIT_BIN}
fi

export PATH=${packages}/perl/bin:$PATH
export PATH=${packages}/git/bin:$PATH
export PATH=${packages}/gitolite/src:$PATH

chpst -u ${GIT_USER_GRP} ${packages}/gitolite/install

echo "${GIT_INITIAL_KEY}" > ${GIT_HOME}/${GIT_USER}.pub
chown ${GIT_USER_GRP} ${GIT_HOME}/${GIT_USER}.pub

# TODO how to make idempotent? what is it doing?
chpst -u ${GIT_USER_GRP} gitolite setup -pk ${GIT_HOME}/${GIT_USER}.pub
